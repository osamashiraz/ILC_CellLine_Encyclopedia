SupFig11B_pval_table <- pairwise.t.test(x = DMI_df_cl$DMI, g = DMI_df_cl$PAM50)$p.value
})
# ------------------------------------------------------------------------------
# SupFig 11C - DMI by Histology (LumA tumors and non-basal cell lines)
# ------------------------------------------------------------------------------
message("Generating SupFig 11C: DMI by Histology...")
# Add RNA subtypes for cell lines
DMI_df$RNA_Subtypes <- CL_Annots[DMI_df$SampleID, "mRNA Subtypes"]
# Filter to LumA tumors and non-basal cell lines
DMI_df_luminal <- DMI_df %>% filter((TissueSource == "Patient Tumors" & PAM50 == "LumA" & Histology %in% c("NST", "ILC")) | (TissueSource == "Normal") |
(TissueSource == "Cell Lines" & RNA_Subtypes %notin% c("Basal")))
tumor_cl_histology_LumA <- ggplot(DMI_df_luminal, aes(x = reorder(Histology_TissueSource, DMI_zscore), y = DMI_zscore)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4, color = "black") +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
tumor_cl_histology_LumA
suppressWarnings({
SupFig11C_pval_table <- pairwise.t.test(x = DMI_df_luminal$DMI, g = DMI_df_luminal$Histology_TissueSource)$p.value
})
# ------------------------------------------------------------------------------
# Fig 4A - DMI by Tissue Source (Normal, Patient Tumors, Cell Lines)
# ------------------------------------------------------------------------------
message("Generating Fig 4A: DMI by Tissue Source...")
# Filter to Luminal A tumors and non-basal cell lines for final DMI_df
normal_subset <- DMI_df$TissueSource == "Normal"
LumA_tumors_subset <- (DMI_df$TissueSource == "Patient Tumors") & (DMI_df$PAM50 == "LumA")
Non_basal_cl_subset <- (DMI_df$TissueSource == "Cell Lines") & (DMI_df$PAM50 != "Basal")
DMI_df <- subset(DMI_df, normal_subset | LumA_tumors_subset | Non_basal_cl_subset)
tissue_dmi <- ggplot(
subset(DMI_df, TissueSource %in% c("Patient Tumors", "Cell Lines", "Normal")) %>%
mutate(TissueSource = forcats::fct_relevel(TissueSource, "Normal", "Patient Tumors", "Cell Lines")),
aes(x = reorder(TissueSource, DMI_zscore), y = DMI_zscore)
) +
ggbeeswarm::geom_quasirandom(aes(color = TissueSource), size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual("Tissue Source", values = annot_cols$Type, guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
theme_bw(20) + xlab(" ") + ylab("DNAm Index") + theme(axis.text.x = element_blank())
tissue_dmi
# Suppress warnings from t.test
suppressWarnings({
t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
})
p1 <- t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
p2 <- t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
p1
p2
DMI_df
DMI_df <- data.frame(
DMI = c(as.numeric(patient_GMA_scores), as.numeric(cell_line_GMA_scores)),
SampleID = c(names(patient_GMA_scores), cellsID),
TissueSource = c(rep("Patient Tumors", length(names(patient_GMA_scores))),
rep("Cell Lines", length(names(cell_line_GMA_scores)))),
Histology = c(TCGA_Annots[names(patient_GMA_scores), "Final Pathology"],
as.character(CL_Annots[cellsID, "Histology"])),
PAM50 = c(TCGA_Annots[names(patient_GMA_scores), "PAM50"],
as.character(CL_Annots[cellsID, "TopCall"]))
)
# Remove duplicates and set row names
DMI_df <- DMI_df[!duplicated(DMI_df$SampleID), ]
rownames(DMI_df) <- DMI_df$SampleID
# Fix PAM50 labels for cell lines with multiple subtypes
idx <- grep(pattern = ";", DMI_df$PAM50)
DMI_df[idx, "PAM50"] <- CL_Annots[DMI_df[idx, "SampleID"], "PCAPAM50"]
# Update TissueSource to "Normal" for normal samples
DMI_df$TissueSource[grepl("-11", DMI_df$SampleID)] <- "Normal"
DMI_df$TissueSource[grepl("-01", DMI_df$SampleID)] <- "Patient Tumors"
# ------------------------------------------------------------------------------
# Step 4: Define group variables for plotting and subsetting
# ------------------------------------------------------------------------------
message("Step 4: Defining group variables...")
# Group labels by histology and tissue source
DMI_df$HistologyGroup <- paste0(DMI_df$Histology, "-", DMI_df$TissueSource)
# Group labels by histology and PAM50 subtype
DMI_df$HistologySubtype <- paste0(DMI_df$Histology, "-", DMI_df$PAM50)
# ------------------------------------------------------------------------------
# Step 5: Compute DMI z-scores and normalize to [0,1]
# ------------------------------------------------------------------------------
message("Step 5: Computing DMI z-scores...")
# Extract DMI scores for normal samples
normal_DMI_scores <- subset(DMI_df, TissueSource == "Normal")$DMI
# Z-score calculation: (DMI - median_normal) / standard deviation_normal
DMI_df$DMI_zscore <- (DMI_df$DMI - median(normal_DMI_scores)) / sqrt(var(normal_DMI_scores))
# ------------------------------------------------------------------------------
# Step 6: Remove outlier normals (z-score > ±1.5)
# ------------------------------------------------------------------------------
message("Step 6: Removing outlier normals...")
outlier_normals <- subset(DMI_df, TissueSource == "Normal" & abs(DMI_zscore) > 1.5)$SampleID
DMI_df <- subset(DMI_df, !(SampleID %in% outlier_normals))
outlier_normals
if (length(outlier_normals) > 0) {
message("  Removed ", length(outlier_normals), " outlier normal samples")
}
# ------------------------------------------------------------------------------
# Step 7: Generate combined histology-type labels
# ------------------------------------------------------------------------------
message("Step 7: Generating combined histology-type labels...")
DMI_df$Histology_TissueSource <- paste0(DMI_df$Histology, " | ", DMI_df$TissueSource)
DMI_df$Histology_TissueSource[DMI_df$Histology_TissueSource == "Normal | Normal"] <- "Normal"
rownames(DMI_df) <- DMI_df$SampleID
# Save DMI summary
write.table(DMI_df, file = file.path(dnam_dir, "DMI_Summary.tsv"),
quote = FALSE, row.names = FALSE, sep = "\t")
message("  ✓ Saved DMI summary to: ", file.path(dnam_dir, "DMI_Summary.tsv"))
message("\n", "=", strrep("=", 78))
message("Section 3: DMI Comparisons and Visualizations")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# SupFig 11A - DMI Patient Tumors By PAM50
# ------------------------------------------------------------------------------
message("Generating SupFig 11A: DMI Patient Tumors by PAM50...")
DMI_df_t <- subset(DMI_df, TissueSource == "Patient Tumors" & PAM50 != "Normal")
tumor_pam50 <- ggplot(DMI_df_t, aes(x = reorder(PAM50, DMI_zscore), y = DMI_zscore, color = PAM50)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual(values = c(annot_cols$PAM50), guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
tumor_pam50
DMI_df_t
patient_GMA_scores
median_normal_beta
# Identify common probes across datasets
allProbes <- intersect(intersect(HM450K_ProbeSet$probeID, rownames(BRCA_CL_DNAm)), rownames(TCGA_BRCA_DNAm))
message("  Common probes across datasets: ", length(allProbes))
message("\n", "=", strrep("=", 78))
message("Section 2: Calculating DMI (DNA Methylation Index)")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# Step 1: Calculate median DNA methylation in normal samples (identified by "-11")
# ------------------------------------------------------------------------------
message("Step 1: Calculating median DNA methylation in normal samples...")
# Extract normal tissue samples
beta_normal_matrix <- TCGA_BRCA_DNAm[allProbes, grepl("-11", colnames(TCGA_BRCA_DNAm))]
# Calculate probe-wise median beta values for normals
median_normal_beta <- apply(beta_normal_matrix[allProbes, ], 1, function(x) median(x, na.rm = TRUE))
message("  Calculated median beta for ", length(median_normal_beta), " probes")
# ------------------------------------------------------------------------------
# Step 2: Calculate Global Methylation Aberration (GMA) scores
# ------------------------------------------------------------------------------
message("Step 2: Calculating Global Methylation Aberration (GMA) scores...")
# GMA scores for patient tumors (sum of absolute deviation from normal medians)
patient_GMA_scores <- colSums(abs(TCGA_BRCA_DNAm[allProbes, ] - as.numeric(median_normal_beta)), na.rm = TRUE)
dim(TCGA_BRCA_DNAm)
# GMA scores for cell lines
cell_line_GMA_scores <- colSums(abs(BRCA_CL_DNAm[allProbes, ] - as.numeric(median_normal_beta)), na.rm = TRUE)
message("  Patient tumors: ", length(patient_GMA_scores), " samples")
message("  Cell lines: ", length(cell_line_GMA_scores), " samples")
# ------------------------------------------------------------------------------
# Step 3: Combine patient and cell line data into a single DataFrame
# ------------------------------------------------------------------------------
message("Step 3: Combining patient and cell line data...")
DMI_df <- data.frame(
DMI = c(as.numeric(patient_GMA_scores), as.numeric(cell_line_GMA_scores)),
SampleID = c(names(patient_GMA_scores), cellsID),
TissueSource = c(rep("Patient Tumors", length(names(patient_GMA_scores))),
rep("Cell Lines", length(names(cell_line_GMA_scores)))),
Histology = c(TCGA_Annots[names(patient_GMA_scores), "Final Pathology"],
as.character(CL_Annots[cellsID, "Histology"])),
PAM50 = c(TCGA_Annots[names(patient_GMA_scores), "PAM50"],
as.character(CL_Annots[cellsID, "TopCall"]))
)
# Remove duplicates and set row names
DMI_df <- DMI_df[!duplicated(DMI_df$SampleID), ]
rownames(DMI_df) <- DMI_df$SampleID
# Fix PAM50 labels for cell lines with multiple subtypes
idx <- grep(pattern = ";", DMI_df$PAM50)
DMI_df[idx, "PAM50"] <- CL_Annots[DMI_df[idx, "SampleID"], "PCAPAM50"]
# Update TissueSource to "Normal" for normal samples
DMI_df$TissueSource[grepl("-11", DMI_df$SampleID)] <- "Normal"
DMI_df$TissueSource[grepl("-01", DMI_df$SampleID)] <- "Patient Tumors"
# ------------------------------------------------------------------------------
# Step 4: Define group variables for plotting and subsetting
# ------------------------------------------------------------------------------
message("Step 4: Defining group variables...")
# Group labels by histology and tissue source
DMI_df$HistologyGroup <- paste0(DMI_df$Histology, "-", DMI_df$TissueSource)
# Group labels by histology and PAM50 subtype
DMI_df$HistologySubtype <- paste0(DMI_df$Histology, "-", DMI_df$PAM50)
# ------------------------------------------------------------------------------
# Step 5: Compute DMI z-scores and normalize to [0,1]
# ------------------------------------------------------------------------------
message("Step 5: Computing DMI z-scores...")
# Extract DMI scores for normal samples
normal_DMI_scores <- subset(DMI_df, TissueSource == "Normal")$DMI
# Z-score calculation: (DMI - median_normal) / standard deviation_normal
DMI_df$DMI_zscore <- (DMI_df$DMI - median(normal_DMI_scores)) / sqrt(var(normal_DMI_scores))
# ------------------------------------------------------------------------------
# Step 6: Remove outlier normals (z-score > ±1.5)
# ------------------------------------------------------------------------------
message("Step 6: Removing outlier normals...")
outlier_normals <- subset(DMI_df, TissueSource == "Normal" & abs(DMI_zscore) > 1.5)$SampleID
DMI_df <- subset(DMI_df, !(SampleID %in% outlier_normals))
if (length(outlier_normals) > 0) {
message("  Removed ", length(outlier_normals), " outlier normal samples")
}
# ------------------------------------------------------------------------------
# Step 7: Generate combined histology-type labels
# ------------------------------------------------------------------------------
message("Step 7: Generating combined histology-type labels...")
DMI_df$Histology_TissueSource <- paste0(DMI_df$Histology, " | ", DMI_df$TissueSource)
DMI_df$Histology_TissueSource[DMI_df$Histology_TissueSource == "Normal | Normal"] <- "Normal"
rownames(DMI_df) <- DMI_df$SampleID
# Save DMI summary
write.table(DMI_df, file = file.path(dnam_dir, "DMI_Summary.tsv"),
quote = FALSE, row.names = FALSE, sep = "\t")
message("  ✓ Saved DMI summary to: ", file.path(dnam_dir, "DMI_Summary.tsv"))
message("\n", "=", strrep("=", 78))
message("Section 3: DMI Comparisons and Visualizations")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# SupFig 11A - DMI Patient Tumors By PAM50
# ------------------------------------------------------------------------------
message("Generating SupFig 11A: DMI Patient Tumors by PAM50...")
DMI_df_t <- subset(DMI_df, TissueSource == "Patient Tumors" & PAM50 != "Normal")
tumor_pam50 <- ggplot(DMI_df_t, aes(x = reorder(PAM50, DMI_zscore), y = DMI_zscore, color = PAM50)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual(values = c(annot_cols$PAM50), guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
tumor_pam50
# Suppress warnings from pairwise.t.test
suppressWarnings({
SupFig11A_pval_table <- pairwise.t.test(x = DMI_df_t$DMI, g = DMI_df_t$PAM50)$p.value
})
# ------------------------------------------------------------------------------
# SupFig 11B - DMI Cell Lines By PAM50
# ------------------------------------------------------------------------------
message("Generating SupFig 11B: DMI Cell Lines by PAM50...")
DMI_df_cl <- subset(DMI_df, TissueSource == "Cell Lines")
DMI_df_cl <- DMI_df_cl[!is.na(DMI_df_cl$PAM50), ]
cl_pam50 <- ggplot(DMI_df_cl, aes(x = reorder(PAM50, DMI_zscore), y = DMI_zscore, color = PAM50)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual(values = c(annot_cols$PAM50), guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
suppressWarnings({
SupFig11B_pval_table <- pairwise.t.test(x = DMI_df_cl$DMI, g = DMI_df_cl$PAM50)$p.value
})
# ------------------------------------------------------------------------------
# SupFig 11C - DMI by Histology (LumA tumors and non-basal cell lines)
# ------------------------------------------------------------------------------
message("Generating SupFig 11C: DMI by Histology...")
# Add RNA subtypes for cell lines
DMI_df$RNA_Subtypes <- CL_Annots[DMI_df$SampleID, "mRNA Subtypes"]
# Filter to LumA tumors and non-basal cell lines
DMI_df_luminal <- DMI_df %>% filter((TissueSource == "Patient Tumors" & PAM50 == "LumA" & Histology %in% c("NST", "ILC")) | (TissueSource == "Normal") |
(TissueSource == "Cell Lines" & RNA_Subtypes %notin% c("Basal")))
tumor_cl_histology_LumA <- ggplot(DMI_df_luminal, aes(x = reorder(Histology_TissueSource, DMI_zscore), y = DMI_zscore)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4, color = "black") +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
suppressWarnings({
SupFig11C_pval_table <- pairwise.t.test(x = DMI_df_luminal$DMI, g = DMI_df_luminal$Histology_TissueSource)$p.value
})
# ------------------------------------------------------------------------------
# Fig 4A - DMI by Tissue Source (Normal, Patient Tumors, Cell Lines)
# ------------------------------------------------------------------------------
message("Generating Fig 4A: DMI by Tissue Source...")
# Filter to Luminal A tumors and non-basal cell lines for final DMI_df
normal_subset <- DMI_df$TissueSource == "Normal"
LumA_tumors_subset <- (DMI_df$TissueSource == "Patient Tumors") & (DMI_df$PAM50 == "LumA")
Non_basal_cl_subset <- (DMI_df$TissueSource == "Cell Lines") & (DMI_df$PAM50 != "Basal")
DMI_df <- subset(DMI_df, normal_subset | LumA_tumors_subset | Non_basal_cl_subset)
tissue_dmi <- ggplot(
subset(DMI_df, TissueSource %in% c("Patient Tumors", "Cell Lines", "Normal")) %>%
mutate(TissueSource = forcats::fct_relevel(TissueSource, "Normal", "Patient Tumors", "Cell Lines")),
aes(x = reorder(TissueSource, DMI_zscore), y = DMI_zscore)
) +
ggbeeswarm::geom_quasirandom(aes(color = TissueSource), size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual("Tissue Source", values = annot_cols$Type, guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
theme_bw(20) + xlab(" ") + ylab("DNAm Index") + theme(axis.text.x = element_blank())
# Suppress warnings from t.test
suppressWarnings({
t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
})
p1 <- t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
p2 <- t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
library(gt)
tissue_dmi_pval <- tibble(`Normal vs Tumor` = p1, `Cell Line vs Tumor` = p2) %>%
gt() %>%
fmt_scientific(columns = everything(), decimals = 3) %>%
tab_header(title = "DMI Z-Score Comparison (p-values)")
message("  ✓ DMI figures assigned to global environment")
message("\n", "=", strrep("=", 78))
message("Section 4: Differential Analysis (TCGA and Cell Lines)")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# TCGA DESeq2 Analysis (LumA ILC vs NST)
# ------------------------------------------------------------------------------
message("TCGA DESeq2 Analysis (LumA ILC vs NST)...")
setwd("~/Documents/ICLE/2-Analysis/Helper_Scripts")
tumor_pam50
ggsave(file.path(DIRS$results_sub$dna_methylation, "Fig4A_DMI_Normal_Tumor_CL.pdf"), tissue_dmi, width = 5, height = 3)
gt::gtsave(tissue_dmi_pval, file.path(DIRS$results_sub$dna_methylation, "Fig4A_DMI_Normal_Tumor_CL_pvalue_table.pdf"))
tissue_dmi
ggsave(file.path(dnam_dir, "SupFig11C_DMI_Tumor_CL_Histology.pdf"), tumor_cl_histology_LumA, width = 4, height = 3)
pdf(file.path(dnam_dir, "SupFig11C_DMI_Tumor_CL_Histology_pvalues_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11C_pval_table, 1))
dev.off()
tumor_cl_histology_LumA
ggsave(file.path(dnam_dir, "SupFig11B_DMI_CL_PAM50.pdf"), cl_pam50, width = 5, height = 3)
pdf(file.path(dnam_dir, "SupFig11B_DMI_CL_PAM50_pvalue_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11B_pval_table, 1))
dev.off()
cl_pam50
ggsave(file.path(dnam_dir, "SupFig11A_DMI_Tumor_PAM50.pdf"), tumor_pam50, width = 5, height = 3)
pdf(file.path(dnam_dir, "SupFig11A_DMI_Tumor_PAM50_pvalue_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11A_pval_table, 1))
dev.off()
tumor_pam50
DMI_df
table(substr(DMI_df$SampleID, 13,15))
# Identify common probes across datasets
allProbes <- intersect(intersect(HM450K_ProbeSet$probeID, rownames(BRCA_CL_DNAm)), rownames(TCGA_BRCA_DNAm))
message("  Common probes across datasets: ", length(allProbes))
# ------------------------------------------------------------------------------
# SECTION 2: Calculate DMI (DNA Methylation Index)
# ------------------------------------------------------------------------------
message("\n", "=", strrep("=", 78))
message("Section 2: Calculating DMI (DNA Methylation Index)")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# Step 1: Calculate median DNA methylation in normal samples (identified by "-11")
# ------------------------------------------------------------------------------
message("Step 1: Calculating median DNA methylation in normal samples...")
# Extract normal tissue samples
beta_normal_matrix <- TCGA_BRCA_DNAm[allProbes, grepl("-11", colnames(TCGA_BRCA_DNAm))]
# Calculate probe-wise median beta values for normals
median_normal_beta <- apply(beta_normal_matrix[allProbes, ], 1, function(x) median(x, na.rm = TRUE))
message("  Calculated median beta for ", length(median_normal_beta), " probes")
# ------------------------------------------------------------------------------
# Step 2: Calculate Global Methylation Aberration (GMA) scores
# ------------------------------------------------------------------------------
message("Step 2: Calculating Global Methylation Aberration (GMA) scores...")
# GMA scores for patient tumors (sum of absolute deviation from normal medians)
patient_GMA_scores <- colSums(abs(TCGA_BRCA_DNAm[allProbes, ] - as.numeric(median_normal_beta)), na.rm = TRUE)
# GMA scores for cell lines
cell_line_GMA_scores <- colSums(abs(BRCA_CL_DNAm[allProbes, ] - as.numeric(median_normal_beta)), na.rm = TRUE)
message("  Patient tumors: ", length(patient_GMA_scores), " samples")
message("  Cell lines: ", length(cell_line_GMA_scores), " samples")
# ------------------------------------------------------------------------------
# Step 3: Combine patient and cell line data into a single DataFrame
# ------------------------------------------------------------------------------
message("Step 3: Combining patient and cell line data...")
DMI_df <- data.frame(
DMI = c(as.numeric(patient_GMA_scores), as.numeric(cell_line_GMA_scores)),
SampleID = c(names(patient_GMA_scores), cellsID),
TissueSource = c(rep("Patient Tumors", length(names(patient_GMA_scores))),
rep("Cell Lines", length(names(cell_line_GMA_scores)))),
Histology = c(TCGA_Annots[names(patient_GMA_scores), "Final Pathology"],
as.character(CL_Annots[cellsID, "Histology"])),
PAM50 = c(TCGA_Annots[names(patient_GMA_scores), "PAM50"],
as.character(CL_Annots[cellsID, "TopCall"]))
)
# Remove duplicates and set row names
DMI_df <- DMI_df[!duplicated(DMI_df$SampleID), ]
rownames(DMI_df) <- DMI_df$SampleID
# Fix PAM50 labels for cell lines with multiple subtypes
idx <- grep(pattern = ";", DMI_df$PAM50)
DMI_df[idx, "PAM50"] <- CL_Annots[DMI_df[idx, "SampleID"], "PCAPAM50"]
# Update TissueSource to "Normal" for normal samples
DMI_df$TissueSource[grepl("-11", DMI_df$SampleID)] <- "Normal"
DMI_df$TissueSource[grepl("-01", DMI_df$SampleID)] <- "Patient Tumors"
# ------------------------------------------------------------------------------
# Step 4: Define group variables for plotting and subsetting
# ------------------------------------------------------------------------------
message("Step 4: Defining group variables...")
# Group labels by histology and tissue source
DMI_df$HistologyGroup <- paste0(DMI_df$Histology, "-", DMI_df$TissueSource)
# Group labels by histology and PAM50 subtype
DMI_df$HistologySubtype <- paste0(DMI_df$Histology, "-", DMI_df$PAM50)
# Filter for relevant histology types
# DMI_df <- subset(DMI_df, Histology %notin% c("Other", "mDLC"))
DMI_df <- DMI_df[grep("-20|-06", DMI_df$SampleID, invert = T), ] # remove -20 and -06 - not primary tumors
# DMI_df <- subset(DMI_df, (TissueSource == "Patient Tumors" & !is.na(Histology)) | TissueSource != "Patient Tumors")
message("  Filtered to ", nrow(DMI_df), " samples (", paste0(names(table(DMI_df$TissueSource)), ": ", table(DMI_df$TissueSource), ". "), ")")
# ------------------------------------------------------------------------------
# Step 5: Compute DMI z-scores and normalize to [0,1]
# ------------------------------------------------------------------------------
message("Step 5: Computing DMI z-scores...")
# Extract DMI scores for normal samples
normal_DMI_scores <- subset(DMI_df, TissueSource == "Normal")$DMI
# Z-score calculation: (DMI - median_normal) / standard deviation_normal
DMI_df$DMI_zscore <- (DMI_df$DMI - median(normal_DMI_scores)) / sqrt(var(normal_DMI_scores))
# ------------------------------------------------------------------------------
# Step 6: Remove outlier normals (z-score > ±1.5)
# ------------------------------------------------------------------------------
message("Step 6: Removing outlier normals...")
outlier_normals <- subset(DMI_df, TissueSource == "Normal" & abs(DMI_zscore) > 1.5)$SampleID
DMI_df <- subset(DMI_df, !(SampleID %in% outlier_normals))
if (length(outlier_normals) > 0) {
message("  Removed ", length(outlier_normals), " outlier normal samples")
}
# ------------------------------------------------------------------------------
# Step 7: Generate combined histology-type labels
# ------------------------------------------------------------------------------
message("Step 7: Generating combined histology-type labels...")
DMI_df$Histology_TissueSource <- paste0(DMI_df$Histology, " | ", DMI_df$TissueSource)
DMI_df$Histology_TissueSource[DMI_df$Histology_TissueSource == "Normal | Normal"] <- "Normal"
rownames(DMI_df) <- DMI_df$SampleID
# Save DMI summary
write.table(DMI_df, file = file.path(dnam_dir, "DMI_Summary.tsv"),
quote = FALSE, row.names = FALSE, sep = "\t")
message("  ✓ Saved DMI summary to: ", file.path(dnam_dir, "DMI_Summary.tsv"))
# ------------------------------------------------------------------------------
# SECTION 3: DMI Comparisons and Visualizations (SupFig11, Fig4A)
# ------------------------------------------------------------------------------
message("\n", "=", strrep("=", 78))
message("Section 3: DMI Comparisons and Visualizations")
message("=", strrep("=", 78))
# ------------------------------------------------------------------------------
# SupFig 11A - DMI Patient Tumors By PAM50
# ------------------------------------------------------------------------------
message("Generating SupFig 11A: DMI Patient Tumors by PAM50...")
DMI_df_t <- subset(DMI_df, TissueSource == "Patient Tumors" & PAM50 != "Normal")
tumor_pam50 <- ggplot(DMI_df_t, aes(x = reorder(PAM50, DMI_zscore), y = DMI_zscore, color = PAM50)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual(values = c(annot_cols$PAM50), guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
# Suppress warnings from pairwise.t.test
suppressWarnings({
SupFig11A_pval_table <- pairwise.t.test(x = DMI_df_t$DMI, g = DMI_df_t$PAM50)$p.value
})
# ------------------------------------------------------------------------------
# SupFig 11B - DMI Cell Lines By PAM50
# ------------------------------------------------------------------------------
message("Generating SupFig 11B: DMI Cell Lines by PAM50...")
DMI_df_cl <- subset(DMI_df, TissueSource == "Cell Lines")
DMI_df_cl <- DMI_df_cl[!is.na(DMI_df_cl$PAM50), ]
cl_pam50 <- ggplot(DMI_df_cl, aes(x = reorder(PAM50, DMI_zscore), y = DMI_zscore, color = PAM50)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual(values = c(annot_cols$PAM50), guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
suppressWarnings({
SupFig11B_pval_table <- pairwise.t.test(x = DMI_df_cl$DMI, g = DMI_df_cl$PAM50)$p.value
})
# ------------------------------------------------------------------------------
# SupFig 11C - DMI by Histology (LumA tumors and non-basal cell lines)
# ------------------------------------------------------------------------------
message("Generating SupFig 11C: DMI by Histology...")
# Add RNA subtypes for cell lines
DMI_df$RNA_Subtypes <- CL_Annots[DMI_df$SampleID, "mRNA Subtypes"]
# Filter to LumA tumors and non-basal cell lines
DMI_df_luminal <- DMI_df %>% filter((TissueSource == "Patient Tumors" & PAM50 == "LumA" & Histology %in% c("NST", "ILC")) | (TissueSource == "Normal") |
(TissueSource == "Cell Lines" & RNA_Subtypes %notin% c("Basal")))
tumor_cl_histology_LumA <- ggplot(DMI_df_luminal, aes(x = reorder(Histology_TissueSource, DMI_zscore), y = DMI_zscore)) +
ggbeeswarm::geom_quasirandom(size = 1, alpha = 1, width = 0.4, color = "black") +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
xlab(" ") + ylab("DNAm Index") + theme_bw(20) + theme(axis.text.x = element_blank())
suppressWarnings({
SupFig11C_pval_table <- pairwise.t.test(x = DMI_df_luminal$DMI, g = DMI_df_luminal$Histology_TissueSource)$p.value
})
# ------------------------------------------------------------------------------
# Fig 4A - DMI by Tissue Source (Normal, Patient Tumors, Cell Lines)
# ------------------------------------------------------------------------------
message("Generating Fig 4A: DMI by Tissue Source...")
# Filter to Luminal A tumors and non-basal cell lines for final DMI_df
normal_subset <- DMI_df$TissueSource == "Normal"
LumA_tumors_subset <- (DMI_df$TissueSource == "Patient Tumors") & (DMI_df$PAM50 == "LumA")
Non_basal_cl_subset <- (DMI_df$TissueSource == "Cell Lines") & (DMI_df$PAM50 != "Basal")
DMI_df <- subset(DMI_df, normal_subset | LumA_tumors_subset | Non_basal_cl_subset)
tissue_dmi <- ggplot(
subset(DMI_df, TissueSource %in% c("Patient Tumors", "Cell Lines", "Normal")) %>%
mutate(TissueSource = forcats::fct_relevel(TissueSource, "Normal", "Patient Tumors", "Cell Lines")),
aes(x = reorder(TissueSource, DMI_zscore), y = DMI_zscore)
) +
ggbeeswarm::geom_quasirandom(aes(color = TissueSource), size = 1, alpha = 1, width = 0.4) +
geom_boxplot(alpha = 0.6, linewidth = 0.4, colour = "black", outlier.color = NA, width = 0.2) +
scale_color_manual("Tissue Source", values = annot_cols$Type, guide = guide_legend(override.aes = list(size = 4, alpha = 1))) +
theme_bw(20) + xlab(" ") + ylab("DNAm Index") + theme(axis.text.x = element_blank())
# Suppress warnings from t.test
suppressWarnings({
t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore,
subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
})
p1 <- t.test(subset(DMI_df, TissueSource == "Normal")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
p2 <- t.test(subset(DMI_df, TissueSource == "Cell Lines")$DMI_zscore, subset(DMI_df, TissueSource == "Patient Tumors")$DMI_zscore)$p.value
library(gt)
tissue_dmi_pval <- tibble(`Normal vs Tumor` = p1, `Cell Line vs Tumor` = p2) %>%
gt() %>%
fmt_scientific(columns = everything(), decimals = 3) %>%
tab_header(title = "DMI Z-Score Comparison (p-values)")
setwd("~/Documents/ICLE/2-Analysis")
ggsave(file.path(dnam_dir, "SupFig11A_DMI_Tumor_PAM50.pdf"), tumor_pam50, width = 5, height = 3)
pdf(file.path(dnam_dir, "SupFig11A_DMI_Tumor_PAM50_pvalue_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11A_pval_table, 1))
dev.off()
tumor_pam50
ggsave(file.path(dnam_dir, "SupFig11B_DMI_CL_PAM50.pdf"), cl_pam50, width = 5, height = 3)
pdf(file.path(dnam_dir, "SupFig11B_DMI_CL_PAM50_pvalue_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11B_pval_table, 1))
dev.off()
cl_pam50
ggsave(file.path(dnam_dir, "SupFig11C_DMI_Tumor_CL_Histology.pdf"), tumor_cl_histology_LumA, width = 4, height = 3)
pdf(file.path(dnam_dir, "SupFig11C_DMI_Tumor_CL_Histology_pvalues_table.pdf"), width = 10, height = 10)
gridExtra::grid.table(signif(SupFig11C_pval_table, 1))
dev.off()
tumor_cl_histology_LumA
ggsave(file.path(DIRS$results_sub$dna_methylation, "Fig4A_DMI_Normal_Tumor_CL.pdf"), tissue_dmi, width = 5, height = 3)
gt::gtsave(tissue_dmi_pval, file.path(DIRS$results_sub$dna_methylation, "Fig4A_DMI_Normal_Tumor_CL_pvalue_table.pdf"))
tissue_dmi
ggsave(file.path(DIRS$results_sub$dna_methylation, "Fig4B_Tumor_RNA_DNAm_Alterations_small_height.pdf"), dnma_lfc_plt, width = 6, height = 5)
